name: Deploy Direct to VPS

on:
  push:
    branches: [ master ]

env:
  NODE_OPTIONS: '--max-old-space-size=4096'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci --prefer-offline --no-audit
        
      - name: Run build test
        run: npm run build
        env:
          NODE_OPTIONS: '--max-old-space-size=4096'
          
      - name: Verify build output
        run: |
          if [ ! -d "out" ]; then
            echo "âŒ Build test failed - no 'out' directory found"
            ls -la
            exit 1
          fi
          echo "âœ… Build test successful - 'out' directory exists"
          ls -la out/ | head -10

  deploy:
    needs: test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code for deployment
        uses: actions/checkout@v4
        with:
          path: 'source'
          
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "ğŸš€ Starting deployment..."
            
            # Check system resources
            echo "ğŸ’¾ Checking system resources..."
            free -h
            df -h /
            
            # Install Node.js if not present
            if ! command -v node &> /dev/null; then
              echo "ğŸ“¦ Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              apt-get install -y nodejs
            fi
            
            # Install Docker if not present
            if ! command -v docker &> /dev/null; then
              echo "ğŸ³ Installing Docker..."
              curl -fsSL https://get.docker.com -o get-docker.sh
              sh get-docker.sh
              systemctl enable docker
              systemctl start docker
              usermod -aG docker $USER
            fi
            
            # Clean project directory
            echo "ğŸ§¹ Cleaning project directory..."
            rm -rf /opt/torregrossa-portfolio
            mkdir -p /opt/torregrossa-portfolio
            
      - name: Copy files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "source/*"
          target: "/opt/torregrossa-portfolio/"
          strip_components: 1
          
      - name: Build and deploy with Docker
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            cd /opt/torregrossa-portfolio
            
            echo "ğŸ“ Checking files..."
            ls -la
            
            if [ ! -f "package.json" ]; then
              echo "âŒ package.json not found!"
              echo "Files in directory:"
              find . -type f -name "*.json" -o -name "*.js" -o -name "*.ts" | head -20
              exit 1
            fi
            
            echo "ğŸ³ Building Docker image (this includes npm install and build)..."
            
            # Clean up old Docker resources first
            echo "ğŸ§¹ Cleaning old Docker resources..."
            docker stop torregrossa-app 2>/dev/null || true
            docker rm torregrossa-app 2>/dev/null || true
            docker rmi torregrossa-portfolio:latest 2>/dev/null || true
            docker system prune -f --volumes
            
            # Build new image
            echo "ğŸ—ï¸ Building new Docker image..."
            docker build -t torregrossa-portfolio:latest . --no-cache
            
            if [ $? -ne 0 ]; then
              echo "âŒ Docker build failed!"
              echo "ğŸ“‹ Docker logs:"
              docker logs $(docker ps -lq) 2>/dev/null || echo "No container logs available"
              echo "ğŸ’¾ System resources after build attempt:"
              free -h
              df -h /
              exit 1
            fi
            
            echo "âœ… Docker image built successfully!"
            docker images | grep torregrossa-portfolio
            
            echo "ğŸš€ Starting new container..."
            docker run -d \
              --name torregrossa-app \
              --restart unless-stopped \
              -p 80:80 \
              --memory="512m" \
              --memory-swap="1g" \
              torregrossa-portfolio:latest
            
            if [ $? -ne 0 ]; then
              echo "âŒ Failed to start container!"
              docker logs torregrossa-app 2>/dev/null || echo "No container logs available"
              exit 1
            fi
            
            echo "â³ Waiting for container to start..."
            sleep 20
            
            echo "ğŸ” Running health check..."
            for i in {1..15}; do
              if curl -f http://localhost:80 >/dev/null 2>&1; then
                echo "âœ… Health check passed!"
                echo "ğŸŒ Site accessible at http://${{ secrets.VPS_HOST }}"
                echo "ğŸ“ Your portfolio is now live at http://217.154.120.146"
                
                # Show container status for confirmation
                echo "ğŸ“Š Container status:"
                docker ps --filter "name=torregrossa-app"
                
                # Show resource usage
                echo "ğŸ’¾ Resource usage:"
                docker stats --no-stream torregrossa-app
                
                # Clean up old images
                echo "ğŸ§¹ Cleaning up old images..."
                docker image prune -f --filter "dangling=true"
                
                exit 0
              else
                echo "â³ Attempt $i/15 - waiting for container..."
                sleep 5
              fi
            done
            
            echo "âŒ Health check failed after 15 attempts!"
            echo "ğŸ“‹ Container logs:"
            docker logs torregrossa-app --tail 50 2>/dev/null || echo "No container logs available"
            echo "ğŸ“Š Container status:"
            docker ps -a --filter "name=torregrossa-app"
            echo "ğŸ” Docker images:"
            docker images | grep torregrossa || echo "No torregrossa images found"
            echo "ğŸ’¾ System resources:"
            free -h
            df -h /
            echo "ğŸ” Nginx error logs:"
            docker exec torregrossa-app cat /var/log/nginx/error.log 2>/dev/null || echo "No nginx error logs"
            exit 1

  notify:
    needs: [test, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Notify deployment status
        run: |
          echo "=== DEPLOYMENT SUMMARY ==="
          echo "Test job: ${{ needs.test.result }}"
          echo "Deploy job: ${{ needs.deploy.result }}"
          
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… Portfolio deployed successfully!"
            echo "ğŸŒ Accessible at: http://217.154.120.146"
            echo "ğŸ“¦ Docker image: torregrossa-portfolio:latest"
            echo "ğŸ³ Container: torregrossa-app"
            echo "ğŸ”§ Memory limit: 512MB (swap: 1GB)"
            echo ""
            echo "ğŸ”— Next steps:"
            echo "1. Configure DNS: torregrossa.dev â†’ 217.154.120.146"
            echo "2. Setup SSL certificate with Let's Encrypt"
            echo "3. Configure domain redirect"
            echo "4. Setup monitoring and backup"
          else
            echo "âŒ Deployment failed! Check the logs above."
            echo "ğŸ” Common issues to check:"
            echo "- Memory usage during build"
            echo "- Docker build process"
            echo "- Network connectivity"
            echo "- Container health status"
            exit 1
          fi